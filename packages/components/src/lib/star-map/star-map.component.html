<div class="star-map-container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1 class="title">Star Map</h1>
      <p class="subtitle">Interactive Celestial Sphere Visualization</p>
    </div>

    <!-- Search Bar -->
    <div class="header-center">
      <div class="search-container">
        <div class="search-input-wrapper">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            class="search-input"
            placeholder="Search stars, planets, constellations..."
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
            (focus)="showSearchResults = true"
            (blur)="onSearchBlur()"
            autocomplete="off"
          />
          <button
            *ngIf="searchQuery"
            class="clear-search-btn"
            (click)="clearSearch()"
            title="Clear search">
            ‚úï
          </button>
        </div>

        <!-- Search Results Dropdown -->
        <div class="search-results" *ngIf="showSearchResults && searchResults.length > 0">
          <div
            *ngFor="let result of searchResults"
            class="search-result-item"
            [class.selected]="result === highlightedResult"
            (mousedown)="selectSearchResult(result)">
            <span class="result-icon">{{ getResultIcon(result.type) }}</span>
            <div class="result-info">
              <div class="result-name">{{ result.name }}</div>
              <div class="result-type">{{ result.typeLabel }}</div>
            </div>
          </div>
        </div>

        <!-- No Results Message -->
        <div class="search-results" *ngIf="showSearchResults && searchQuery && searchResults.length === 0">
          <div class="no-results">
            <p>No objects found matching "{{ searchQuery }}"</p>
          </div>
        </div>
      </div>
    </div>

    <div class="header-right">
      <!-- Time Controls -->
      <div class="time-controls">
        <div class="time-step-controls">
          <button class="time-step-btn" (click)="stepTime(-30, 'day')" title="Back 1 month">
            <span>‚è™</span>
          </button>
          <button class="time-step-btn" (click)="stepTime(-1, 'day')" title="Back 1 day">
            <span>‚óÄ‚óÄ</span>
          </button>
          <button class="time-step-btn" (click)="stepTime(-1, 'hour')" title="Back 1 hour">
            <span>‚óÄ</span>
          </button>

          <button
            class="time-play-btn"
            [class.playing]="isAnimationPlaying"
            (click)="toggleTimeAnimation()"
            [title]="isAnimationPlaying ? 'Pause' : 'Play'">
            <span>{{ isAnimationPlaying ? '‚è∏' : '‚ñ∂' }}</span>
          </button>

          <button class="time-step-btn" (click)="stepTime(1, 'hour')" title="Forward 1 hour">
            <span>‚ñ∂</span>
          </button>
          <button class="time-step-btn" (click)="stepTime(1, 'day')" title="Forward 1 day">
            <span>‚ñ∂‚ñ∂</span>
          </button>
          <button class="time-step-btn" (click)="stepTime(30, 'day')" title="Forward 1 month">
            <span>‚è©</span>
          </button>
        </div>

        <div class="animation-speed" *ngIf="isAnimationPlaying">
          <label class="speed-label">Speed:</label>
          <select class="speed-select" [(ngModel)]="animationSpeed" (change)="onAnimationSpeedChange()">
            <option [value]="1">1x</option>
            <option [value]="5">5x</option>
            <option [value]="10">10x</option>
            <option [value]="30">30x</option>
            <option [value]="60">60x (1 min/sec)</option>
            <option [value]="1440">1440x (1 day/sec)</option>
          </select>
        </div>
      </div>

      <button
        class="highlights-toggle"
        [class.active]="showHighlightsPanel"
        (click)="toggleHighlightsPanel()"
        title="Toggle Tonight's Highlights">
        <span class="highlights-icon">‚ú®</span>
        <span class="highlights-text">Tonight's Sky</span>
      </button>
      <div class="time-display">
        <div class="time-value">{{ state.observerTime | date:'short' }}</div>
        <div class="location-name">{{ state.observerLocation.name }}</div>
      </div>
      <button
        class="tracking-toggle"
        [class.active]="state.isRealTimeTracking"
        (click)="toggleRealTimeTracking()"
        title="Toggle real-time tracking">
        <span class="tracking-icon">üîÑ</span>
        <span class="tracking-text">{{ state.isRealTimeTracking ? 'LIVE' : 'Track' }}</span>
      </button>
      <div class="fps-counter">{{ fps.toFixed(0) }} FPS</div>
    </div>
  </div>

  <!-- Three.js Renderer Container -->
  <div #rendererContainer class="renderer-container"></div>

  <!-- Hover Tooltip -->
  <div class="hover-tooltip" *ngIf="hoveredObject" [style.left.px]="tooltipPosition.x + 15" [style.top.px]="tooltipPosition.y + 15">
    <div class="tooltip-header">
      <span class="tooltip-icon">{{ hoveredObject.type === 'star' ? '‚≠ê' : 'ü™ê' }}</span>
      <span class="tooltip-name">{{ hoveredObject.name }}</span>
    </div>
    <div class="tooltip-info">
      <div class="tooltip-row">
        <span class="tooltip-label">Magnitude:</span>
        <span class="tooltip-value">{{ hoveredObject.magnitude.toFixed(1) }}</span>
      </div>
      <div class="tooltip-row" *ngIf="hoveredObject.constellation">
        <span class="tooltip-label">Constellation:</span>
        <span class="tooltip-value">{{ hoveredObject.constellation }}</span>
      </div>
    </div>
  </div>

  <!-- Tonight's Highlights Panel -->
  <div class="highlights-panel" *ngIf="showHighlightsPanel">
    <div class="highlights-header">
      <div class="highlights-title">
        <span class="highlights-title-icon">‚ú®</span>
        <h2>Tonight's Sky Highlights</h2>
      </div>
      <button class="highlights-close-btn" (click)="toggleHighlightsPanel()" title="Close">‚úï</button>
    </div>

    <div class="highlights-content" *ngIf="tonightsSkyReport">
      <!-- Summary Section -->
      <div class="highlights-summary">
        <div class="summary-badge">
          <span class="summary-icon">üåå</span>
          <span class="summary-text">{{ tonightsSkyReport.visiblePlanets.length }} planets, {{ tonightsSkyReport.brightStars.length }} bright stars</span>
        </div>
        <div class="summary-location">
          <span class="location-icon">üìç</span>
          <span class="location-text">{{ tonightsSkyReport.location }}</span>
        </div>
      </div>

      <!-- Highlights List -->
      <div class="highlights-list">
        <div
          *ngFor="let highlight of tonightsSkyReport.highlights"
          class="highlight-item"
          [class.priority-5]="highlight.priority === 5"
          [class.priority-4]="highlight.priority === 4"
          (click)="selectHighlight(highlight)">
          <div class="highlight-icon-wrapper">
            <span class="highlight-icon">{{ highlight.icon }}</span>
            <span class="highlight-priority" *ngIf="highlight.priority >= 4">!</span>
          </div>
          <div class="highlight-content">
            <div class="highlight-title">{{ highlight.title }}</div>
            <div class="highlight-description">{{ highlight.description }}</div>
            <div class="highlight-meta" *ngIf="highlight.currentAltitude !== undefined">
              <span class="meta-item">
                <span class="meta-label">Altitude:</span>
                <span class="meta-value">{{ highlight.currentAltitude.toFixed(1) }}¬∞</span>
              </span>
              <span class="meta-item" *ngIf="highlight.bestViewingTime">
                <span class="meta-label">Best:</span>
                <span class="meta-value">{{ highlight.bestViewingTime | date:'shortTime' }}</span>
              </span>
            </div>
          </div>
        </div>
        <div *ngIf="tonightsSkyReport.highlights.length === 0" class="no-highlights">
          <p>No special highlights for tonight</p>
        </div>
      </div>

      <!-- Best Viewing Period -->
      <div class="highlights-footer" *ngIf="tonightsSkyReport.bestViewingPeriod">
        <div class="footer-label">Best Viewing Period</div>
        <div class="footer-value">
          {{ tonightsSkyReport.bestViewingPeriod.start | date:'shortTime' }} -
          {{ tonightsSkyReport.bestViewingPeriod.end | date:'shortTime' }}
        </div>
        <div class="footer-reason">{{ tonightsSkyReport.bestViewingPeriod.reason }}</div>
      </div>
    </div>

    <div class="highlights-loading" *ngIf="!tonightsSkyReport">
      <div class="loading-spinner"></div>
      <p>Generating sky highlights...</p>
    </div>
  </div>

  <!-- Left Panel: Visible Stars -->
  <div class="left-panel" [class.collapsed]="isLeftPanelCollapsed">
    <button *ngIf="isLeftPanelCollapsed" class="panel-expand-btn" (click)="toggleLeftPanel()" title="Expand panel">
      <span class="expand-icon">‚ñ∂</span>
    </button>

    <div class="panel-content">
      <div class="panel-header">
        <h2 class="panel-title">Visible Stars</h2>
        <button class="panel-toggle-btn" (click)="toggleLeftPanel()" [title]="'Collapse panel'">
          <span class="toggle-icon">‚óÄ</span>
        </button>
      </div>

      <div class="panel-section no-top-padding">
        <h3 class="section-subtitle">Bright Stars</h3>
        <div class="visible-stars-list">
          <div
            *ngFor="let star of visibleStars"
            class="star-item"
            [class.selected]="selectedStar?.id === star.id"
            (click)="selectStar(star)">
            <div class="star-name">
              <span class="star-icon">‚≠ê</span>
              <span>{{ star.name || star.bayer || 'Star ' + star.id }}</span>
            </div>
            <div class="star-magnitude">mag {{ star.magnitude.toFixed(1) }}</div>
          </div>
          <div *ngIf="visibleStars.length === 0" class="no-stars">
            <p>No bright stars visible at this time</p>
          </div>
        </div>

        <h3 class="section-subtitle">Planets & Moon</h3>
        <div class="visible-planets-list">
          <div
            *ngFor="let planet of visiblePlanets"
            class="planet-item"
            [class.selected]="selectedPlanet?.name === planet.name"
            (click)="selectPlanet(planet)">
            <div class="planet-name">
              <span class="planet-icon">{{ planet.name === 'Moon' ? 'üåô' : 'ü™ê' }}</span>
              <span>{{ planet.name }}</span>
            </div>
            <div class="planet-magnitude">mag {{ planet.magnitude.toFixed(1) }}</div>
          </div>
          <div *ngIf="visiblePlanets.length === 0" class="no-planets">
            <p>No planets visible at this time</p>
          </div>
        </div>

        <div class="rise-set-info" *ngIf="selectedStar && riseSetInfo">
          <div class="info-header">
            <h4>{{ selectedStar.name || selectedStar.bayer || 'Star ' + selectedStar.id }}</h4>
            <button class="close-btn" (click)="clearStarSelection()">‚úï</button>
          </div>

          <div class="status-badge" [class.visible]="riseSetInfo.isVisible" [class.hidden]="!riseSetInfo.isVisible">
            {{ riseSetInfo.isVisible ? 'üåü Visible' : 'üåë Below Horizon' }}
          </div>

          <div class="time-info">
            <div class="time-row">
              <span class="time-label">Rise:</span>
              <span class="time-value">{{ formatTime(riseSetInfo.rise) }}</span>
            </div>
            <div class="time-row">
              <span class="time-label">Transit:</span>
              <span class="time-value">{{ formatTime(riseSetInfo.transit) }}</span>
            </div>
            <div class="time-row">
              <span class="time-label">Set:</span>
              <span class="time-value">{{ formatTime(riseSetInfo.set) }}</span>
            </div>
          </div>

          <div class="star-details">
            <div class="detail-row">
              <span class="detail-label">Constellation:</span>
              <span class="detail-value">{{ selectedStar.constellation }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">RA:</span>
              <span class="detail-value">{{ selectedStar.ra.toFixed(2) }}h</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Dec:</span>
              <span class="detail-value">{{ selectedStar.dec.toFixed(2) }}¬∞</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Spectral Class:</span>
              <span class="detail-value">{{ selectedStar.spectralClass }}</span>
            </div>
          </div>
        </div>

        <div class="rise-set-info planet-info" *ngIf="selectedPlanet && planetRiseSetInfo">
          <div class="info-header">
            <h4>{{ selectedPlanet.name }}</h4>
            <button class="close-btn" (click)="clearPlanetSelection()">‚úï</button>
          </div>

          <div class="status-badge" [class.visible]="planetRiseSetInfo.isVisible" [class.hidden]="!planetRiseSetInfo.isVisible">
            {{ planetRiseSetInfo.isVisible ? 'üåü Visible' : 'üåë Below Horizon' }}
          </div>

          <div class="time-info">
            <div class="time-row">
              <span class="time-label">Rise:</span>
              <span class="time-value">{{ formatTime(planetRiseSetInfo.rise) }}</span>
            </div>
            <div class="time-row">
              <span class="time-label">Transit:</span>
              <span class="time-value">{{ formatTime(planetRiseSetInfo.transit) }}</span>
            </div>
            <div class="time-row">
              <span class="time-label">Set:</span>
              <span class="time-value">{{ formatTime(planetRiseSetInfo.set) }}</span>
            </div>
          </div>

          <div class="star-details">
            <div class="detail-row">
              <span class="detail-label">Magnitude:</span>
              <span class="detail-value">{{ selectedPlanet.magnitude.toFixed(1) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">RA:</span>
              <span class="detail-value">{{ selectedPlanet.position.ra.toFixed(2) }}h</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Dec:</span>
              <span class="detail-value">{{ selectedPlanet.position.dec.toFixed(2) }}¬∞</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Distance:</span>
              <span class="detail-value">{{ selectedPlanet.position.distance.toFixed(3) }} AU</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Phase:</span>
              <span class="detail-value">{{ (selectedPlanet.phase * 100).toFixed(0) }}% illuminated</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Angular Size:</span>
              <span class="detail-value">{{ selectedPlanet.angularSize.toFixed(1) }}"</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Panel: Control Panel -->
  <div class="control-panel" [class.collapsed]="isRightPanelCollapsed">
    <button *ngIf="isRightPanelCollapsed" class="panel-expand-btn" (click)="toggleRightPanel()" title="Expand panel">
      <span class="expand-icon">‚óÄ</span>
    </button>

    <div class="panel-content">
      <div class="panel-header">
        <h2 class="panel-title">Controls</h2>
        <button class="panel-toggle-btn" (click)="toggleRightPanel()" title="Collapse panel">
          <span class="toggle-icon">‚ñ∂</span>
        </button>
      </div>

      <div class="panel-section no-top-padding">
      <h3 class="section-title">Location</h3>

      <div class="control-group">
        <div class="location-selector">
          <button class="location-button" (click)="toggleLocationDropdown()">
            <span class="location-icon">üìç</span>
            <span class="location-text">{{ state.observerLocation.name }}</span>
            <span class="dropdown-arrow">{{ showLocationDropdown ? '‚ñ≤' : '‚ñº' }}</span>
          </button>

          <div class="location-dropdown" *ngIf="showLocationDropdown">
            <button
              class="location-option geolocation-option"
              (click)="useCurrentLocation()"
              [disabled]="isGeolocating">
              <span class="option-icon">{{ isGeolocating ? '‚åõ' : 'üåê' }}</span>
              <span class="option-text">{{ isGeolocating ? 'Getting location...' : 'Use Current Location' }}</span>
            </button>

            <div class="location-divider"></div>

            <button
              *ngFor="let location of presetLocations"
              class="location-option"
              [class.selected]="location.name === state.observerLocation.name"
              (click)="selectLocation(location)">
              <span class="option-icon">üìç</span>
              <span class="option-text">{{ location.name }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="location-info">
          <div class="info-row">
            <span class="info-label">Latitude:</span>
            <span class="info-value">{{ state.observerLocation.latitude.toFixed(4) }}¬∞</span>
          </div>
          <div class="info-row">
            <span class="info-label">Longitude:</span>
            <span class="info-value">{{ state.observerLocation.longitude.toFixed(4) }}¬∞</span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <h3 class="section-title">Time Controls</h3>

      <div class="control-group">
        <button class="btn-now" (click)="setToNow()">
          ‚è∞ Set to Now
        </button>
      </div>

      <div class="control-group">
        <div class="tracking-info" *ngIf="state.isRealTimeTracking">
          <span class="live-indicator">üî¥</span>
          <span class="live-text">Live Tracking Active</span>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <h3 class="section-title">Display Options</h3>

      <div class="control-group">
        <label class="control-label">
          <input
            type="checkbox"
            [(ngModel)]="state.showConstellationLines"
            (change)="toggleConstellationLines()"
          />
          <span>Show Constellation Lines</span>
        </label>
      </div>

      <div class="control-group">
        <label class="control-label">
          <input
            type="checkbox"
            [(ngModel)]="state.showConstellationLabels"
            (change)="toggleConstellationLabels()"
          />
          <span>Show Labels</span>
        </label>
      </div>

      <div class="control-group">
        <label class="control-label">
          <input
            type="checkbox"
            [(ngModel)]="state.showGrid"
            (change)="toggleGrid()"
          />
          <span>Show Horizon</span>
        </label>
      </div>

      <div class="control-group">
        <label class="control-label">
          <input
            type="checkbox"
            [(ngModel)]="state.showPlanetTrails"
            (change)="togglePlanetTrails()"
          />
          <span>Show Planet Trails</span>
        </label>
      </div>

      <div class="control-group" *ngIf="state.showPlanetTrails">
        <button class="btn-clear-trails" (click)="clearPlanetTrails()">
          üóëÔ∏è Clear Trails
        </button>
      </div>
    </div>

    <div class="panel-section">
      <h3 class="section-title">Star Filter</h3>

      <div class="control-group">
        <label class="slider-label">
          <span>Max Magnitude</span>
          <span class="slider-value">{{ state.maxMagnitude.toFixed(1) }}</span>
        </label>
        <input
          type="range"
          min="1"
          max="6.5"
          step="0.1"
          [(ngModel)]="state.maxMagnitude"
          (input)="updateMagnitudeFilter($any($event.target).value)"
          class="slider"
        />
        <div class="slider-hint">Lower values = brighter stars only</div>
      </div>

      <div class="control-group">
        <label class="slider-label">
          <span>Star Size</span>
          <span class="slider-value">{{ state.starSizeScale.toFixed(1) }}x</span>
        </label>
        <input
          type="range"
          min="0.5"
          max="2.0"
          step="0.1"
          [(ngModel)]="state.starSizeScale"
          (input)="updateStarSize()"
          class="slider"
        />
      </div>
    </div>

    <div class="panel-section">
      <h3 class="section-title">Info</h3>
      <div class="info-text">
        <p><strong>Stars:</strong> {{ stars.length }}</p>
        <p><strong>Constellations:</strong> {{ constellations.length }}</p>
        <p><strong>Location:</strong> {{ state.observerLocation.name }}</p>
      </div>
      <div class="controls-hint">
        <p><strong>Mouse Controls:</strong></p>
        <ul>
          <li>Left click + drag: Rotate</li>
          <li>Right click + drag: Pan</li>
          <li>Scroll: Zoom</li>
        </ul>
      </div>
    </div>
    </div>
  </div>
</div>
