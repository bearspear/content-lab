<div class="world-clock-container" [attr.data-theme]="currentTheme">
  <!-- Header -->
  <div class="header" [class.collapsed]="isHeaderCollapsed">
    <div class="header-title-row">
      <div class="header-content">
        <h1>World Clock</h1>
        <p class="subtitle" *ngIf="!isHeaderCollapsed">View time across multiple time zones</p>
      </div>
      <button class="collapse-btn" (click)="toggleHeader()" [title]="isHeaderCollapsed ? 'Expand header' : 'Collapse header'">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path *ngIf="!isHeaderCollapsed" stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          <path *ngIf="isHeaderCollapsed" stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="toolbar-btn" (click)="toggle24Hour()" [title]="show24Hour ? 'Switch to 12-hour format' : 'Switch to 24-hour format'">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span>{{ show24Hour ? '24h' : '12h' }}</span>
      </button>
      <button class="toolbar-btn" (click)="openSettingsModal()" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.25m4.24 4.24l4.24 4.25M1 12h6m6 0h6M5.64 18.36l4.24-4.25m4.24-4.24l4.24-4.25"/>
        </svg>
        <span>Settings</span>
      </button>
    </div>

    <div class="toolbar-center">
      <button class="toolbar-btn" (click)="toggleMoonPanel()" [class.active]="showMoonPanel" title="Moon Phase Information">
        <span class="moon-icon">{{ moonPhase?.emoji || 'üåô' }}</span>
        <span>Moon</span>
      </button>
      <button class="toolbar-btn" (click)="toggleSolarPanel()" [class.active]="showSolarPanel" title="Solar Information">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <span>Solar</span>
      </button>
      <button class="toolbar-btn" (click)="toggleLunarCalendar()" [class.active]="showLunarCalendar" title="Lunar Calendar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span>Calendar</span>
      </button>
    </div>

    <div class="toolbar-right">
      <span class="toolbar-info">{{ clocks.length }} Clocks</span>
    </div>
  </div>

  <!-- Clocks Grid -->
  <div class="clocks-grid">
    <div class="clock-wrapper" *ngFor="let clock of clocks">
      <app-analog-clock
        [config]="clock"
        (timezoneClick)="openTimezoneModal($event)"
        (styleClick)="openStyleModal($event)">
      </app-analog-clock>
    </div>
  </div>

  <!-- Panel Backdrop -->
  <div class="panel-backdrop"
       *ngIf="showMoonPanel || showSolarPanel || showLunarCalendar"
       (click)="showMoonPanel = false; showSolarPanel = false; showLunarCalendar = false">
  </div>

  <!-- Moon Phase Panel -->
  <div class="info-panel moon-panel" *ngIf="showMoonPanel && moonPhase">
    <div class="panel-header">
      <h3>
        <span class="panel-icon">{{ moonPhase.emoji }}</span>
        Moon Phase Information
      </h3>
      <button class="panel-close-btn" (click)="toggleMoonPanel()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">Current Phase</div>
          <div class="info-value moon-phase-name">{{ moonPhase.phaseName }}</div>
        </div>
        <div class="info-card">
          <div class="info-label">Illumination</div>
          <div class="info-value">{{ moonPhase.illumination }}%</div>
        </div>
        <div class="info-card">
          <div class="info-label">Moon Age</div>
          <div class="info-value">{{ moonPhase.age | number: '1.1-1' }} days</div>
        </div>
        <div class="info-card">
          <div class="info-label">Next Full Moon</div>
          <div class="info-value">{{ moonPhase.nextFullMoon | date: 'MMM d, y' }}</div>
          <div class="info-subtext">in {{ moonPhase.daysUntilFullMoon | number: '1.0-0' }} days</div>
        </div>
        <div class="info-card">
          <div class="info-label">Next New Moon</div>
          <div class="info-value">{{ moonPhase.nextNewMoon | date: 'MMM d, y' }}</div>
          <div class="info-subtext">in {{ moonPhase.daysUntilNewMoon | number: '1.0-0' }} days</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Solar Information Panel -->
  <div class="info-panel solar-panel" *ngIf="showSolarPanel && solarInfo">
    <div class="panel-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="panel-icon">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        Solar Information
        <span class="location-label" *ngIf="currentLocation">- {{ currentLocation.name }}</span>
      </h3>
      <button class="panel-close-btn" (click)="toggleSolarPanel()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div class="info-grid">
        <div class="info-card highlight">
          <div class="info-label">Sunrise</div>
          <div class="info-value">{{ solarInfo.sunrise | date: 'h:mm a' }}</div>
        </div>
        <div class="info-card highlight">
          <div class="info-label">Sunset</div>
          <div class="info-value">{{ solarInfo.sunset | date: 'h:mm a' }}</div>
        </div>
        <div class="info-card">
          <div class="info-label">Solar Noon</div>
          <div class="info-value">{{ solarInfo.solarNoon | date: 'h:mm a' }}</div>
        </div>
        <div class="info-card">
          <div class="info-label">Day Length</div>
          <div class="info-value">{{ formatDayLength(solarInfo.dayLength) }}</div>
        </div>
      </div>

      <div class="twilight-section">
        <h4>Golden Hours</h4>
        <div class="info-grid">
          <div class="info-card golden">
            <div class="info-label">Morning Golden Hour</div>
            <div class="info-value">{{ solarInfo.goldenHourMorning.start | date: 'h:mm a' }} - {{ solarInfo.goldenHourMorning.end | date: 'h:mm a' }}</div>
          </div>
          <div class="info-card golden">
            <div class="info-label">Evening Golden Hour</div>
            <div class="info-value">{{ solarInfo.goldenHourEvening.start | date: 'h:mm a' }} - {{ solarInfo.goldenHourEvening.end | date: 'h:mm a' }}</div>
          </div>
        </div>
      </div>

      <div class="twilight-section">
        <h4>Twilight Times</h4>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-label">Civil Twilight</div>
            <div class="info-value">{{ solarInfo.civilTwilight.dawn | date: 'h:mm a' }} - {{ solarInfo.civilTwilight.dusk | date: 'h:mm a' }}</div>
          </div>
          <div class="info-card">
            <div class="info-label">Nautical Twilight</div>
            <div class="info-value">{{ solarInfo.nauticalTwilight.dawn | date: 'h:mm a' }} - {{ solarInfo.nauticalTwilight.dusk | date: 'h:mm a' }}</div>
          </div>
          <div class="info-card">
            <div class="info-label">Astronomical Twilight</div>
            <div class="info-value">{{ solarInfo.astronomicalTwilight.dawn | date: 'h:mm a' }} - {{ solarInfo.astronomicalTwilight.dusk | date: 'h:mm a' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lunar Calendar Panel -->
  <div class="info-panel lunar-calendar-panel" *ngIf="showLunarCalendar">
    <div class="panel-header">
      <h3>
        <span class="panel-icon">üóìÔ∏è</span>
        Lunar Calendar
      </h3>
      <button class="panel-close-btn" (click)="toggleLunarCalendar()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <!-- Month Navigation -->
      <div class="calendar-controls">
        <button class="calendar-nav-btn" (click)="previousMonth()" title="Previous Month">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        <h4 class="calendar-month-title">{{ getMonthName() }}</h4>
        <button class="calendar-nav-btn" (click)="nextMonth()" title="Next Month">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      </div>

      <!-- Calendar Grid -->
      <div class="calendar-grid">
        <!-- Day Names Header -->
        <div class="calendar-day-header">Sun</div>
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>

        <!-- Calendar Days -->
        <div
          *ngFor="let day of getCalendarDays()"
          class="calendar-day"
          [class.today]="day.isToday"
          [class.empty]="!day.date"
          [title]="day.phase ? day.phase.phaseName + ' - ' + day.phase.illumination + '% illuminated' : ''"
        >
          <div class="day-number" *ngIf="day.date">{{ day.date.getDate() }}</div>
          <div class="day-moon" *ngIf="day.phase">
            {{ day.phase.emoji }}
          </div>
          <div class="day-phase-name" *ngIf="day.phase && (day.phase.phaseName === 'Full Moon' || day.phase.phaseName === 'New Moon')">
            {{ day.phase.phaseName === 'Full Moon' ? 'Full' : 'New' }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Timezone Selection Modal -->
  <div class="modal-overlay" *ngIf="showTimezoneModal" (click)="closeTimezoneModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Select Timezone</h2>
        <button class="close-btn" (click)="closeTimezoneModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <!-- Search -->
        <div class="search-box">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-icon">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (input)="searchTimezones()"
            placeholder="Search cities or timezones..."
            class="search-input"
            autocomplete="off"
          />
        </div>

        <!-- Timezone List -->
        <div class="timezone-list">
          <div
            *ngFor="let tz of filteredTimezones"
            class="timezone-item"
            (click)="selectTimezone(tz)"
          >
            <div class="timezone-name">{{ tz.displayName }}</div>
            <div class="timezone-offset">{{ tz.offset }}</div>
          </div>

          <div *ngIf="filteredTimezones.length === 0" class="no-results">
            No timezones found
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Clock Style Selection Modal -->
  <div class="modal-overlay" *ngIf="showStyleModal" (click)="closeStyleModal()">
    <div class="modal-content style-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Select Clock Style</h2>
        <button class="close-btn" (click)="closeStyleModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="style-grid">
          <div
            *ngFor="let style of clockStyles"
            class="style-option"
            [class.selected]="selectedClockConfig?.faceStyle === style.value"
            (click)="selectClockStyle(style.value)"
          >
            <div class="style-preview" [attr.data-style]="style.value">
              <div class="preview-label">{{ style.label }}</div>
            </div>
            <div class="style-name">{{ style.label }}</div>
            <div class="style-description">{{ style.description }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" *ngIf="showSettingsModal" (click)="closeSettingsModal()">
    <div class="modal-content settings-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="close-btn" (click)="closeSettingsModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="settings-section">
          <h3>Default Clock Style</h3>
          <p class="setting-description">Choose the default style for new clocks</p>
          <div class="style-selector">
            <label *ngFor="let style of clockStyles" class="style-radio">
              <input
                type="radio"
                name="defaultStyle"
                [value]="style.value"
                [(ngModel)]="globalSettings.defaultFaceStyle"
                (change)="saveSettings()"
              />
              <span class="radio-label">{{ style.label }}</span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3>Date Format</h3>
          <p class="setting-description">How dates should be displayed</p>
          <div class="style-selector">
            <label class="style-radio">
              <input
                type="radio"
                name="dateFormat"
                value="us"
                [(ngModel)]="globalSettings.dateFormat"
                (change)="saveSettings()"
              />
              <span class="radio-label">US (MM/DD/YYYY)</span>
            </label>
            <label class="style-radio">
              <input
                type="radio"
                name="dateFormat"
                value="eu"
                [(ngModel)]="globalSettings.dateFormat"
                (change)="saveSettings()"
              />
              <span class="radio-label">EU (DD/MM/YYYY)</span>
            </label>
            <label class="style-radio">
              <input
                type="radio"
                name="dateFormat"
                value="iso"
                [(ngModel)]="globalSettings.dateFormat"
                (change)="saveSettings()"
              />
              <span class="radio-label">ISO (YYYY-MM-DD)</span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3>Theme</h3>
          <p class="setting-description">Choose the application theme</p>
          <div class="style-selector">
            <label class="style-radio">
              <input
                type="radio"
                name="theme"
                value="light"
                [(ngModel)]="globalSettings.theme"
                (change)="saveSettings()"
              />
              <span class="radio-label">Light</span>
            </label>
            <label class="style-radio">
              <input
                type="radio"
                name="theme"
                value="dark"
                [(ngModel)]="globalSettings.theme"
                (change)="saveSettings()"
              />
              <span class="radio-label">Dark</span>
            </label>
            <label class="style-radio">
              <input
                type="radio"
                name="theme"
                value="auto"
                [(ngModel)]="globalSettings.theme"
                (change)="saveSettings()"
              />
              <span class="radio-label">Auto</span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3>Data Management</h3>
          <p class="setting-description">Export or import your clock configurations</p>
          <div class="data-buttons">
            <button class="data-btn export-btn" (click)="exportConfiguration()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export Configuration
            </button>
            <button class="data-btn import-btn" (click)="importConfiguration()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Import Configuration
            </button>
          </div>
          <input
            type="file"
            #fileInput
            accept=".json"
            (change)="handleFileImport($event)"
            style="display: none;"
          />
        </div>
      </div>
    </div>
  </div>
</div>
